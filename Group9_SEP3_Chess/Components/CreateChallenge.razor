@using Group9_SEP3_Chess.Models
@using Group9_SEP3_Chess.Data
@using Group9_SEP3_Chess.Authentication
@inject AuthenticationStateProvider authenticationStateProvider;

@inject IChallenge challenge

<h3>Challenge User</h3>
<div>
    <EditForm Model="@newChallenge" OnValidSubmit="@HandleValidSubmit" OnInvalidSubmit="@HandleInvalidSubmit">
        <DataAnnotationsValidator/>
        <ValidationSummary/>
        <div class="form-group">
            Select turn length:<br/>
            <InputSelect @bind-Value="newChallenge.TurnLength">
                <option></option>
                @foreach (var (key, value) in turnLengths)
                {
                    <option value="@key">@value</option>
                }
            </InputSelect>
        </div>
        <div style="display: flex;align-items: center">
            <div class="form-group">
                User to challenge:<br/>
                <InputText @bind-Value="newChallenge.Username"/>
            </div>
            @if (showError)
            {
                <p style="color:@ErrorColor;margin: 0 10px;">@ErrorMessage</p>
            }
        </div>
        <p class="actions" style="margin-bottom: 50px">
            <button class="btn btn-outline-dark" type="submit">Challenge</button>
        </p>
    </EditForm>
</div>

@code {
    private string Username { get; set; }

    private string ErrorMessage { get; set; }
    private string ErrorColor { get; set; }
    
    private readonly IDictionary<int, string> turnLengths = new Dictionary<int, string>
    {
        {120,"2 Minutes"}, {1800,"30 Minutes"}, {3600,"1 Hour"}, {7200,"2 Hours"}, {36000,"10 Hours"}, {86400,"1 Day"}, {259200,"3 Days"}, {604800,"7 Days"}
    };
    
    private Challenge newChallenge = new();

    private bool showError;

    protected override void OnInitialized()
    {
        // load username from currently logged in user
        // Username = loggedInUser.Username
        Username = ((CustomAuthenticationStateProvider) authenticationStateProvider).GetCachedUser().Username;
    }
    
    private async Task HandleValidSubmit()
    {
        showError = false;
        newChallenge.Challenger = Username;

        var result = await challenge.ChallengeUser(newChallenge);

        ErrorColor = result.Contains("Failed") ? "red" : "green";
        showError = true;
        ErrorMessage = result;
    }
    
    private void HandleInvalidSubmit()
    {
        
    }
}